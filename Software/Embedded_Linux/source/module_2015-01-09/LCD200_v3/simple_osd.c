#include <linux/module.h>
#include <linux/init.h>
#include <linux/miscdevice.h>
#include <linux/proc_fs.h>
#include <asm/uaccess.h>

#include "ffb.h"
#include "dev.h"
#include "debug.h"
#include "ffbosd_api.h"

#ifdef LCD210                   // workaround
extern void lcd210_set_prst(struct ffb_dev_info *ff_dev_info);
#endif
spinlock_t irqlock;

typedef enum {
    OSD_STATE_NONE = 0x1,
    OSD_STATE_DISABLE = 0x2,
    OSD_STATE_ENABLE = 0x4,
    OSD_STATE_TOGGLE = 0x8,
} osd_state_t;

static osd_state_t  osd_state = OSD_STATE_NONE;

#define FONT_IDX_SZ     512

typedef struct
{
    unsigned short   font;
    unsigned short   b_change;
} font_idx_t;

static font_idx_t   font_idx_db[FONT_IDX_SZ];

#ifdef SIMPLE_OSD
typedef enum FTLCD200SOSD_REGISTER_tag {
    SCAL_DIM = 0x2000,          //Scaling and Dimensino Control
    POSITION = 0x2004,          //Position Control
    FG_COLOR = 0x2008,          //Foreground Color Control
    BG_COLOR = 0x200c,          //Background Color Control
    FONT_DATABASE = 0x8000,     //Font Database Write Accessing Port
    FONT_DISPLAY = 0xC000,      //Fonts are used to build an OSD window.
} FTLCD200SOSD_REGISTER;

static struct fiosd_char OSD_Font[] = {
    {
     .font_index = 0x30,        //Char:[0]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x1b, 0x00, 0x31, 0x80, 0x31,
                 0x80, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80,
                 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x1b, 0x00, 0x0e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x31,        //Char:[1]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06,
                 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00,
                 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x1f, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x32,        //Char:[2]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x31, 0x80, 0x31, 0x80, 0x31,
                 0x80, 0x03, 0x00, 0x06, 0x00, 0x0c, 0x00,
                 0x18, 0x00, 0x10, 0x00, 0x39, 0x80, 0x35, 0x80, 0x33, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x33,        //Char:[3]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x31, 0x80, 0x33, 0x00, 0x33,
                 0x00, 0x06, 0x00, 0x0e, 0x00, 0x03, 0x00,
                 0x01, 0x80, 0x01, 0x80, 0x31, 0x80, 0x33, 0x00, 0x1e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x34,        //Char:[4]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x07, 0x00, 0x07, 0x00, 0x0f,
                 0x00, 0x0b, 0x00, 0x1b, 0x00, 0x13, 0x00,
                 0x33, 0x00, 0x3f, 0x80, 0x03, 0x00, 0x03, 0x00, 0x0f, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x35,        //Char:[5]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x31, 0x80, 0x31, 0x80, 0x30,
                 0x00, 0x3e, 0x00, 0x33, 0x00, 0x31, 0x80,
                 0x01, 0x80, 0x01, 0x80, 0x31, 0x80, 0x33, 0x00, 0x1e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x36,        //Char:[6]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x19, 0x80, 0x31, 0x80, 0x30,
                 0x00, 0x3e, 0x00, 0x3b, 0x00, 0x31, 0x80,
                 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x1b, 0x00, 0x0e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x37,        //Char:[7]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3d, 0x80, 0x33, 0x80, 0x31, 0x80, 0x31,
                 0x00, 0x03, 0x00, 0x03, 0x00, 0x03, 0x00,
                 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x38,        //Char:[8]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x1b, 0x00, 0x31, 0x80, 0x31,
                 0x80, 0x1b, 0x00, 0x0e, 0x00, 0x1b, 0x00,
                 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x1b, 0x00, 0x0e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x39,        //Char:[9]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x1b, 0x00, 0x31, 0x80, 0x31,
                 0x80, 0x31, 0x80, 0x31, 0x80, 0x1b, 0x80,
                 0x0d, 0x80, 0x01, 0x80, 0x31, 0x80, 0x33, 0x00, 0x1e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x41,        //Char:[A]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x04, 0x00, 0x0e, 0x00, 0x0e,
                 0x00, 0x0a, 0x00, 0x0a, 0x00, 0x1b, 0x00,
                 0x1f, 0x00, 0x1b, 0x00, 0x1b, 0x00, 0x1b, 0x00, 0x3b, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x42,        //Char:[B]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x19, 0x80, 0x19, 0x80, 0x19,
                 0x80, 0x19, 0x80, 0x1f, 0x00, 0x19, 0x80,
                 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x3f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x43,        //Char:[C]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x80, 0x1b, 0x80, 0x31, 0x80, 0x30,
                 0x80, 0x30, 0x80, 0x30, 0x00, 0x30, 0x00,
                 0x30, 0x00, 0x30, 0x00, 0x30, 0x80, 0x19, 0x80, 0x0f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x44,        //Char:[D]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x1b, 0x00, 0x19, 0x80, 0x19,
                 0x80, 0x19, 0x80, 0x19, 0x80, 0x19, 0x80,
                 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x1b, 0x00, 0x3e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x45,        //Char:[E]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x19, 0x80, 0x19, 0x80, 0x18,
                 0x00, 0x19, 0x00, 0x1f, 0x00, 0x19, 0x00,
                 0x19, 0x00, 0x18, 0x00, 0x19, 0x80, 0x19, 0x80, 0x3f, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x46,        //Char:[F]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x19, 0x80, 0x19, 0x80, 0x18,
                 0x00, 0x19, 0x00, 0x1f, 0x00, 0x19, 0x00,
                 0x19, 0x00, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x3e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x47,        //Char:[G]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0d, 0x80, 0x1b, 0x80, 0x31, 0x80, 0x31,
                 0x80, 0x30, 0x00, 0x30, 0x00, 0x37, 0x80,
                 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x1b, 0x80, 0x0d, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x48,        //Char:[H]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x31,
                 0x80, 0x31, 0x80, 0x3f, 0x80, 0x31, 0x80,
                 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x49,        //Char:[I]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x0c,
                 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x0c, 0x00,
                 0x0c, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x3f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x4a,        //Char:[J]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x06, 0x00, 0x06, 0x00, 0x06,
                 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00,
                 0x06, 0x00, 0x36, 0x00, 0x36, 0x00, 0x36, 0x00, 0x3c, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x4b,        //Char:[K]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3b, 0x80, 0x19, 0x80, 0x1b, 0x00, 0x1b,
                 0x00, 0x1e, 0x00, 0x1c, 0x00, 0x1e, 0x00,
                 0x1b, 0x00, 0x1b, 0x00, 0x19, 0x80, 0x19, 0x80, 0x3b, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x4c,        //Char:[L]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x18, 0x00, 0x18, 0x00, 0x18,
                 0x00, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00,
                 0x18, 0x00, 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x3f, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x4d,        //Char:[M]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x31, 0x80, 0x31, 0x80, 0x3b, 0x80, 0x3b,
                 0x80, 0x3b, 0x80, 0x3f, 0x80, 0x35, 0x80,
                 0x35, 0x80, 0x35, 0x80, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x4e,        //Char:[N]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3b, 0x80, 0x19, 0x80, 0x19, 0x80, 0x1d,
                 0x80, 0x1d, 0x80, 0x1d, 0x80, 0x1b, 0x80,
                 0x1b, 0x80, 0x1b, 0x80, 0x19, 0x80, 0x19, 0x80, 0x3d, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x4f,        //Char:[O]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x1b, 0x00, 0x31, 0x80, 0x31,
                 0x80, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80,
                 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x1b, 0x00, 0x0e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x50,        //Char:[P]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x1b, 0x00, 0x19, 0x80, 0x19,
                 0x80, 0x19, 0x80, 0x19, 0x80, 0x1b, 0x00,
                 0x1e, 0x00, 0x18, 0x00, 0x18, 0x00, 0x18, 0x00, 0x3e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x51,        //Char:[Q]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x1b, 0x00, 0x31, 0x80, 0x31,
                 0x80, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80,
                 0x31, 0x80, 0x35, 0x80, 0x3b, 0x80, 0x1b, 0x00, 0x0f, 0x00, 0x01,
                 0x80, 0x00, 0x00,},
     },
    {
     .font_index = 0x52,        //Char:[R]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x19, 0x80, 0x19, 0x80, 0x19,
                 0x80, 0x19, 0x80, 0x1b, 0x00, 0x1e, 0x00,
                 0x1b, 0x00, 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x3d, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x53,        //Char:[S]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x0e, 0x80, 0x1b, 0x80, 0x31, 0x80, 0x30,
                 0x80, 0x30, 0x80, 0x1c, 0x00, 0x07, 0x00,
                 0x21, 0x80, 0x21, 0x80, 0x31, 0x80, 0x3b, 0x00, 0x2e, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x54,        //Char:[T]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x16, 0x80, 0x16, 0x80, 0x16,
                 0x80, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00,
                 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x0f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x55,        //Char:[U]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3b, 0x80, 0x19, 0x80, 0x19, 0x80, 0x19,
                 0x80, 0x19, 0x80, 0x19, 0x80, 0x19, 0x80,
                 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x19, 0x80, 0x0f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x56,        //Char:[V]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3b, 0x80, 0x1b, 0x00, 0x1b, 0x00, 0x1b,
                 0x00, 0x1b, 0x00, 0x1b, 0x00, 0x1b, 0x00,
                 0x0e, 0x00, 0x0e, 0x00, 0x0e, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x57,        //Char:[W]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x31, 0x80, 0x31, 0x80, 0x31, 0x80, 0x31,
                 0x80, 0x35, 0x80, 0x35, 0x80, 0x35, 0x80,
                 0x3f, 0x80, 0x1f, 0x00, 0x1b, 0x00, 0x1b, 0x00, 0x1b, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x58,        //Char:[X]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3b, 0x80, 0x3b, 0x80, 0x11, 0x00, 0x1b,
                 0x00, 0x1b, 0x00, 0x0e, 0x00, 0x0e, 0x00,
                 0x1b, 0x00, 0x1b, 0x00, 0x11, 0x00, 0x3b, 0x80, 0x3b, 0x80, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x59,        //Char:[Y]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3b, 0x80, 0x19, 0x80, 0x19, 0x80, 0x19,
                 0x80, 0x19, 0x80, 0x0f, 0x00, 0x06, 0x00,
                 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x06, 0x00, 0x0f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x5a,        //Char:[Z]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x33, 0x00, 0x33, 0x00, 0x36,
                 0x00, 0x06, 0x00, 0x0c, 0x00, 0x0c, 0x00,
                 0x18, 0x00, 0x1b, 0x00, 0x33, 0x00, 0x33, 0x00, 0x3f, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x20,        //Char:[ ]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x3d,        //Char:[=]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00,
                 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x2c,        //Char:[,]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x0c, 0x00, 0x04,
                 0x00, 0x08, 0x00,},
     },
    {
     .font_index = 0x2d,        //Char:[-]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x2f,        //Char:[/]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x08,
                 0x00, 0x08, 0x00, 0x08, 0x00, 0x10, 0x00,
                 0x10, 0x00, 0x10, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
    {
     .font_index = 0x3a,        //Char:[:]
     .fbitmap = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x06,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x06, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00,},
     },
};
static struct lcd200_dev_info *pdev_info = NULL;
static struct fiosd_charmap charmap = { {0} };

static void fsosd_ctrl(int on)
{
    if (on) {
        pdev_info->ops->reg_write((struct ffb_dev_info *)pdev_info, FEATURE, 0x10, 0x10);
    } else {
        pdev_info->ops->reg_write((struct ffb_dev_info *)pdev_info, FEATURE, 0x0, 0x10);
    }
#ifdef LCD210
    lcd210_set_prst((struct ffb_dev_info *)pdev_info);
#endif
}

/**
 * Set OSD window position.
 **/
static void fsosd_Pos(int HPos, int VPos)
{
    u32 tmp;

    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;
    iowrite32((HPos & 0xfff) << 12 | (VPos & 0x7ff), pfdi->io_base + POSITION);

    /* update to hardware */
    tmp = ioread32(pfdi->io_base + SCAL_DIM);
#ifdef LCD210
    iowrite32(tmp, pfdi->io_base + SCAL_DIM);
    lcd210_set_prst(pfdi);
#else
    iowrite32((tmp | (0x1 << 20)), pfdi->io_base + SCAL_DIM);
#endif
}

/**
 * Set OSD window dimension
 **/
static void fsosd_Dim(int HDim, int VDim)
{
    u32 value;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;
    value = ioread32(pfdi->io_base + SCAL_DIM);
    value &= ~((0x1F << 4) | (0x3F << 12));
    value |= (((HDim & 0x3F) << 12) | (VDim & 0x1F) << 4);
    iowrite32(value, pfdi->io_base + SCAL_DIM);
#ifdef LCD210
    lcd210_set_prst(pfdi);
#endif
}

static void fsosd_transparent(int level)
{
    u32 value;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;

    value = ioread32(pfdi->io_base + BG_COLOR);
    value &= ~(0x3);
    if (level > 3)
        level = 3;
    if (level < 0)
        level = 0;
    value |= (level & 0x3);
    iowrite32(value, pfdi->io_base + BG_COLOR);
}

static void fsosd_fg_color(int pal0, int pal1, int pal2, int pal3)
{
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;
    iowrite32((pal0) | (pal1 << 8) | (pal2 << 16) | (pal3 << 24), pfdi->io_base + FG_COLOR);
}

static void fsosd_bg_color(int pal1, int pal2, int pal3)
{
    u32 value;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;
    value = ioread32(pfdi->io_base + BG_COLOR);
    value &= ~(0xffffff00);
    value |= (pal1 << 8) | (pal2 << 16) | (pal3 << 24);
    iowrite32(value, pfdi->io_base + BG_COLOR);
}

static void fsosd_Scal(int HScal, int VScal)
{
    u32 value;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;
    value = ioread32(pfdi->io_base + SCAL_DIM);
    value &= ~(0xf);
    if (HScal > 3)
        HScal = 3;
    if (HScal < 0)
        HScal = 0;
    if (VScal > 3)
        VScal = 3;
    if (VScal < 0)
        VScal = 0;
    value |= (HScal << 2) | (VScal) | (0x1 << 20);
    iowrite32(value, pfdi->io_base + SCAL_DIM);

#ifdef LCD210
    lcd210_set_prst(pfdi);
#endif

}

static void fsosd_putc(char c, int position, unsigned int value)
{
#if 1
    unsigned short  real_val;

    if (position >= FONT_IDX_SZ)
        panic("%s, posistion = %d \n", __func__, position);

    real_val = (c << 4) | value;
    if (font_idx_db[position].font != real_val) {
        font_idx_db[position].font = real_val;
        font_idx_db[position].b_change = 1;
        osd_state = OSD_STATE_TOGGLE;
    }
#else
    //Add By Ken.Hsieh
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;
    iowrite32((c << 4) | value, pfdi->io_base + FONT_DISPLAY + position * 4);
#endif
}

static void fsosd_puts(char *str, int position, unsigned int value, unsigned int i_col,
                       unsigned int i_len)
{
    int i;
//Modified By Ken.Hsieh
    if (i_len == 0) {
        for (i = 0; i < strlen(str); i++)
            fsosd_putc(*(str + i), position + i, value);
    } else {
        for (i = i_col; i < (i_len + i_col); i++)
            fsosd_putc(*(str + i), position + i, value);
    }
}

static void fsosd_String(int row, int mode, char *str, int fg_color, int bg_color,
                         unsigned int i_column, unsigned int i_len)
{
    unsigned int value = fg_color | bg_color;

    fsosd_puts(str, row, value, i_column, i_len);

    if (mode == 2) {            //YCbCr
        //Modify By Ken.Hsieh for change palette to make font become clear
        fsosd_fg_color(0x97, 0x4B, 0x7B, 0xFC);
        fsosd_bg_color(0x97, 0x4B, 0x7B);
    } else {
        fsosd_fg_color(0x07, 0x38, 0xC0, 0xFF);
        fsosd_bg_color(0x07, 0x38, 0xc0);
    }
}

//Add By Ken.Hsieh
static void fsosd_Remove_Char(char tmp)
{
    unsigned int x, y, j, i;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;

    charmap.map[(int)tmp] = 0;

    for (i = 0; i < 16; i++) {
        x = 0;
        y = 0;
        for (j = 0; j < 12; j++) {      //reorder
            if (y & 1)
                x |= 1;
            y >>= 1;
            x <<= 1;
        }
        x >>= 1;
        iowrite32(x, pfdi->io_base + FONT_DATABASE + tmp * 64 + i * 4);
    }
}

void fsosd_Set_Char(struct fiosd_char *data)    //OSD Font Database insert
{
    int i, j, x, y, k;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;

    k = 0;
    for (i = 0; i < 16; i++) {
        x = 0;
        y = data->fbitmap[k] << 4 | ((data->fbitmap[k + 1] >> 4) & 0x0f);
        //printk("0x%x\n",y);
        for (j = 0; j < 12; j++) {      //reorder
            if (y & 1)
                x |= 1;
            y >>= 1;
            x <<= 1;
        }
        x >>= 1;

        iowrite32(x, pfdi->io_base + FONT_DATABASE + data->font_index * 64 + i * 4);
        k += 2;
    }
    charmap.map[data->font_index] = 0;
}

static int fsosd_open(struct inode *inode, struct file *file)
{
    int ret = 0;
    DBGENTER(1);
    if (pdev_info == NULL) {
        err("Device info is NULL");
        ret = -EFAULT;
        goto end;
    }
  end:
    DBGLEAVE(1);
    return ret;
}

static int fsosd_release(struct inode *inode, struct file *file)
{
    int ret = 0;
    DBGENTER(1);
    DBGLEAVE(1);
    return ret;
}

static long fsosd_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
{
    int idx, ret = 0;
    struct fosd_data *pFosd = NULL;

    pFosd = (struct fosd_data *)kmalloc(sizeof(struct fosd_data), GFP_KERNEL);
    if (pFosd == NULL)
        return -ENOMEM;

    DBGENTER(1);
    switch (cmd) {
    case FOSD_ON:
        DBGPRINT(3, "FOSD_ON:\n");
        osd_state = OSD_STATE_ENABLE;
        for (idx = 0; idx < FONT_IDX_SZ; idx ++) {
            if (font_idx_db[idx].b_change) {
                osd_state |= OSD_STATE_TOGGLE;
                break;
            }
        }
        //fsosd_ctrl(1);
        break;
    case FOSD_OFF:
        DBGPRINT(3, "FOSD_OFF:\n");
        osd_state = OSD_STATE_DISABLE;
        //fsosd_ctrl(0);
        break;
    case FOSD_SETPOS:
        DBGPRINT(3, "FOSD_SETPOS:\n");
        if (copy_from_user(pFosd, (unsigned int *)arg, 2 * sizeof(unsigned int))) {
            ret = -EFAULT;
            break;
        }
        fsosd_Pos(pFosd->HPos, pFosd->VPos);
        break;
    case FOSD_SETDIM:
        DBGPRINT(3, "FOSD_SETDIM:\n");
        if (copy_from_user(pFosd, (unsigned int *)arg, 4 * sizeof(unsigned int))) {
            ret = -EFAULT;
            break;
        }
        //Add By Ken.Hsieh
        if (pFosd->HDim > 63) {
            printk("Over HDim Spec\n");
            return -EFAULT;
        }
        if (pFosd->VDim > 31) {
            printk("Over VDim Spec\n");
            return -EFAULT;
        }

        fsosd_Dim(pFosd->HDim, pFosd->VDim);
        //printk("OSD_Dim=%d %d\n",fosd.HDim,fosd.VDim);
        break;
    case FOSD_SETSCAL:
        DBGPRINT(3, "FOSD_SETSCAL:\n");
        if (copy_from_user(pFosd, (unsigned int *)arg, 7 * sizeof(unsigned int))) {
            ret = -EFAULT;
            break;
        }
        fsosd_Scal(pFosd->HScal, pFosd->VScal);
        //printk("OSD_Scal=%d %d\n",fosd.HScal,fosd.VScal);
        break;
    case FLCD_SET_TRANSPARENT:
        DBGPRINT(3, "FLCD_SET_TRANSPARENT:\n");
        if (copy_from_user(pFosd, (unsigned int *)arg, 5 * sizeof(unsigned int))) {
            ret = -EFAULT;
            break;
        }
        fsosd_transparent(pFosd->transparent_level);
        //printk("OSD_transparent=%d\n",fosd.transparent_level);
        break;
    case FLCD_SET_STRING:
        {
            int i;
            unsigned long flags;

            DBGPRINT(3, "FLCD_SET_STRING:\n");
            if (copy_from_user(pFosd, (unsigned int *)arg, sizeof(struct fosd_data))) {
                ret = -EFAULT;
                break;
            }
            /* save irq */
            spin_lock_irqsave(&irqlock, flags);

            for (i = 0; i < pFosd->VDim; i++) {
                fsosd_String(pFosd->Str_Data[i].Str_row,
                             pFosd->Str_Data[i].display_mode,
                             pFosd->Str_Data[i].Str_OSD,
                             pFosd->Str_Data[i].fg_color,
                             pFosd->Str_Data[i].bg_color,
                             pFosd->Str_Data[i].column, pFosd->Str_Data[i].len);
            }
            /* restore irq */
            spin_unlock_irqrestore(&irqlock, flags);

            /*printk("OSD_String=%d %d %s %d %d\n", fosd.Str_Data[i].Str_row,
               fosd.Str_Data[i].display_mode,
               fosd.Str_Data[i].Str_OSD,
               fosd.Str_Data[i].fg_color,
               fosd.Str_Data[i].bg_color); */
            break;
        }
    case FOSD_QUERY_CHARMAP:
        if (copy_to_user((struct fiosd_charmap_t *)arg, &charmap, sizeof(charmap))) {
            return -EFAULT;
        }
        break;
    case FOSD_RMCHAR:
        {
            char c_tmp;
            if (copy_from_user(&c_tmp, (char *)arg, sizeof(c_tmp))) {
                return -EFAULT;
            }
            fsosd_Remove_Char(c_tmp);
            break;
        }
    case FOSD_SET_CHAR:
        {
            struct fiosd_char tmp;
            if (copy_from_user(&tmp, (unsigned int *)arg, sizeof(struct fiosd_char))) {
                return -EFAULT;
            }
            //printk("font_index:%d\n",tmp.font_index);
            fsosd_Set_Char(&tmp);
            break;
        }
    default:
        ret = -ENOIOCTLCMD;
        break;
    }
    if (pFosd)
        kfree(pFosd);

    DBGLEAVE(1);
    return ret;
}

void fosd_update(void)
{
    int     idx;
    struct ffb_dev_info *pfdi = (struct ffb_dev_info *)pdev_info;

    /* update font index */
    for (idx = 0; idx < FONT_IDX_SZ; idx ++) {
        if (likely(!font_idx_db[idx].b_change))
            continue;

        iowrite32(font_idx_db[idx].font, pfdi->io_base + FONT_DISPLAY + (idx << 2));
        font_idx_db[idx].b_change = 0;
    }
}

void fosd_handler(void)
{
    switch (osd_state)
    {
      case OSD_STATE_NONE:
        return; //do nothing
      case OSD_STATE_DISABLE:
        fsosd_ctrl(0);
        osd_state = OSD_STATE_NONE;
        break;
      case OSD_STATE_ENABLE:
        fsosd_ctrl(1);
        osd_state = OSD_STATE_NONE;
        break;
      default:
        if (osd_state & OSD_STATE_TOGGLE) {
            osd_state &= ~OSD_STATE_TOGGLE; //clear OSD_STATE_TOGGLE
            fsosd_ctrl(0);
            fosd_update();
            if (osd_state & OSD_STATE_ENABLE)
                fsosd_ctrl(1);
        }
        osd_state = OSD_STATE_NONE;
        break;
    }
}


static const struct file_operations fsosd_fops = {
    .owner = THIS_MODULE,
    .open = fsosd_open,
    .release = fsosd_release,
    .unlocked_ioctl = fsosd_ioctl,
};

static struct miscdevice misdev = { 0 };

void fsosd_deconstruct(struct lcd200_dev_info *info)
{
    DBGENTER(1);
    if (pdev_info == info) {
        misc_deregister(&misdev);
        pdev_info = NULL;
    }
    DBGLEAVE(1);
}

int fsosd_construct(struct lcd200_dev_info *info)
{
    int ret = 0;
    int i;

    DBGENTER(1);
    if (pdev_info != NULL) {
        ret = -EBUSY;
        goto err;
    }

    memset(&misdev, 0, sizeof(misdev));
    if (info->lcd200_idx == LCD_ID) {
        misdev.minor = MISC_DYNAMIC_MINOR - 1;  // temp sol.
        misdev.name = "fbosd";
    } else if (info->lcd200_idx == LCD1_ID) {
        misdev.minor = MISC_DYNAMIC_MINOR;
        misdev.name = "fbosd1";
    } else {
        misdev.minor = MISC_DYNAMIC_MINOR;
        misdev.name = "fbosd2";
    }

    misdev.fops = (struct file_operations *)&fsosd_fops;
    ret = misc_register(&misdev);
    if (ret) {
        err("misc_register failed!");
        goto err;
    }
    pdev_info = info;
    for (i = 0; i < ARRAY_SIZE(OSD_Font); i++) {
        fsosd_Set_Char(&OSD_Font[i]);
    }

    memset(&font_idx_db[0], 0, sizeof(font_idx_db));
    spin_lock_init(&irqlock);

    DBGLEAVE(1);
    return ret;
  err:
    fsosd_deconstruct(info);
    DBGLEAVE(1);
    return ret;
}
#else
void fsosd_deconstruct(struct lcd200_dev_info *info)
{
    DBGENTER(1);
    DBGLEAVE(1);
}

int fsosd_construct(struct lcd200_dev_info *info)
{
    int ret = 0;
    DBGENTER(1);
    DBGLEAVE(1);
    return ret;
}
#endif

#if 0
EXPORT_SYMBOL(fsosd_deconstruct);
EXPORT_SYMBOL(fsosd_construct);
#endif
